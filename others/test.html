<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>
</head>
<body>
	<script src="../out.js"></script>
	<script>

		const code = `

		const canvas = window.document.createElement('canvas');
		canvas.width = canvas.height = 500;
		canvas.style.border = '1px solid black';
		window.document.body.appendChild(canvas);

		const ctx = canvas.getContext('2d');

		const grid = createGrid(30);
		let gridOffset = 0;

		let x = 0;
		let y = 0;

		let nx = 0;
		let ny = 0;

		window.onmousemove = function (event) {
			const box = canvas.getBoundingClientRect();
			nx = event.clientX - box.x;
			ny = event.clientY - box.y;
		}

		function createGrid(size) {
			const canvas = window.document.createElement('canvas');
			canvas.width = canvas.height = size;

			const ctx = canvas.getContext('2d');

			ctx.strokeStyle = '#000';
			ctx.lineWidth = 1;
			ctx.strokeRect(0, 0, size, size);

			return ctx.createPattern(canvas, 'repeat');
		}

		function animate() {
			gridOffset += 1;

			x += (nx - x) * 0.1;
			y += (ny - y) * 0.1;

			ctx.fillStyle = '#ddd';
			ctx.fillRect(0, 0, canvas.width, canvas.height);

			ctx.beginPath();
			ctx.rect(0, 0, canvas.width, canvas.height);

			ctx.save();
			ctx.fillStyle = grid;
			ctx.globalAlpha = 0.2;
			ctx.translate(gridOffset, gridOffset);
			ctx.fill();
			ctx.restore();

			const r = Math.sin(Date.now() / 100) * 10 + 30;

			ctx.beginPath();
			ctx.arc(x, y, r, 0, Math.PI * 2);
			ctx.fillStyle = 'lime';
			ctx.fill();

			ctx.save();
			ctx.clip();
			ctx.lineWidth = 8;
			ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
			ctx.stroke();

			ctx.restore();

			window.requestAnimationFrame(animate);
		}

		animate();

		`;

		Module().then(wasm => {
			const bytes = wasm.getBytecode(code);

			const base64 = toBase64(bytes);
			console.log(base64);

			wasm.eval(bytes);
		});

		function toBase64(array) {
			let string = '';
			for (let i = 0; i < array.length; i++) {
				string += String.fromCharCode(array[i]);
			}
			return btoa(string);
		}

	</script>
</body>
</html>